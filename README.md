# Учебная виртуальная машина (УВМ)

## Общее описание

Проект реализует полный цикл работы с учебной виртуальной машиной, включающий ассемблер и интерпретатор. Ассемблер преобразует программы, написанные в JSON-формате, в бинарный машинный код. Интерпретатор выполняет скомпилированные программы, используя объединенную модель памяти для команд и данных, и сохраняет дамп памяти в формате CSV.

Проект состоит из двух основных компонентов:

- Ассемблер (`cmd/uvm-as`) - читает JSON-представление программы и генерирует бинарный файл
- Интерпретатор (`cmd/uvm-run`) - исполняет бинарный файл, ведет объединенную память команд и данных, сохраняет дамп памяти в CSV

## Описание функций и настроек

### Ассемблер (uvm-as)

Ассемблер принимает программы в формате JSON и преобразует их в бинарный машинный код.

#### Аргументы командной строки

- `--src <путь>` - обязательный аргумент, путь к исходному JSON-файлу с программой
- `--out <путь>` - обязательный аргумент в обычном режиме, путь к выходному бинарному файлу
- `--test` - флаг тестового режима, при котором выводится внутреннее представление программы и байтовое представление команд

#### Функциональность

- Парсинг JSON-программ с валидацией синтаксиса
- Трансляция инструкций в промежуточное представление (IR)
- Кодирование инструкций в машинный код (два байта на инструкцию)
- Генерация бинарного файла с машинным кодом
- Вывод размера сгенерированного файла в байтах
- В тестовом режиме: вывод внутреннего представления и байтового кода

#### Поддерживаемые опкоды

- `LOAD_CONST` (A=5) - загрузка константы в аккумулятор. Требует аргумент `value` (0-4095)
- `LOAD_MEM` (A=15) - чтение значения из памяти по адресу, находящемуся в аккумуляторе. Результат записывается в аккумулятор
- `STORE_MEM` (A=14) - сохранение значения аккумулятора в память. Требует аргумент `addr` (0-4095)
- `NEG` (A=3) - унарный минус над значением аккумулятора

### Интерпретатор (uvm-run)

Интерпретатор выполняет скомпилированные программы и сохраняет дамп памяти.

#### Аргументы командной строки

- `<binary>` - путь к бинарному файлу с машинным кодом
- `<csv_out>` - путь к файлу для сохранения дампа памяти в формате CSV
- `<start>` - начальный адрес диапазона памяти для дампа (целое число)
- `<end>` - конечный адрес диапазона памяти для дампа (целое число)

#### Функциональность

- Загрузка машинного кода из бинарного файла в память, начиная с адреса 0
- Выполнение программы: чтение инструкций, декодирование, выполнение команд
- Объединенная модель памяти (65536 ячеек) для команд и данных
- Сохранение дампа указанного диапазона адресов в CSV-формат

#### Модель выполнения

- Аккумулятор (Acc) - регистр для хранения промежуточных результатов
- Счетчик команд (PC) - указатель на текущую инструкцию в байтах
- Память - объединенное адресное пространство для команд и данных
- Цикл выполнения: чтение двух байтов, декодирование, выполнение команды, переход к следующей инструкции

### Формат программы (JSON)

Программа представляет собой JSON-объект со списком инструкций:

```json
{
  "instructions": [
    { "op": "LOAD_CONST", "args": { "value": 703 } },
    { "op": "LOAD_MEM",   "args": {} },
    { "op": "STORE_MEM",  "args": { "addr": 389 } },
    { "op": "NEG",        "args": {} }
  ]
}
```

Каждая инструкция содержит:
- `op` - строковое имя опкода
- `args` - объект с аргументами инструкции (числовые значения)

### Формат дампа памяти (CSV)

Дамп памяти сохраняется в формате CSV с двумя колонками:
- Первая колонка - адрес памяти
- Вторая колонка - значение в ячейке памяти

## Команды для сборки проекта и запуска тестов

### Требования

- Go версии 1.25.2 или выше

### Сборка проекта

Проект использует `go run` для запуска без предварительной компиляции. Для сборки исполняемых файлов:

```bash
go build -o uvm-as ./cmd/uvm-as
go build -o uvm-run ./cmd/uvm-run
```

### Запуск ассемблера

Обычный режим (генерация бинарного файла):
```bash
go run ./cmd/uvm-as --src <путь_к_json> --out <путь_к_bin>
```

Тестовый режим (вывод внутреннего представления и байтов):
```bash
go run ./cmd/uvm-as --src <путь_к_json> --test
```

### Запуск интерпретатора

```bash
go run ./cmd/uvm-run <путь_к_bin> <путь_к_csv> <начальный_адрес> <конечный_адрес>
```

### Запуск тестов

Для запуска unit-тестов (если они присутствуют):
```bash
go test ./...
```

## Примеры использования

### Пример 1: Базовое использование

Создание и выполнение простой программы:

```bash
# Ассемблирование
go run ./cmd/uvm-as --src prog.json --out prog.bin

# Выполнение
go run ./cmd/uvm-run prog.bin dump.csv 0 400

# Просмотр результата
cat dump.csv
```

### Пример 2: Тестовый режим ассемблера

Просмотр внутреннего представления и байтового кода:

```bash
go run ./cmd/uvm-as --src prog.json --test
```

Вывод содержит:
- Номер инструкции
- Опкод
- Аргументы инструкции
- Байтовое представление (два байта в шестнадцатеричном формате)

### Пример 3: Программа с унарным минусом (prog_neg.json)

Программа загружает константу 21, применяет унарный минус и сохраняет результат:

```bash
go run ./cmd/uvm-as --src prog_neg.json --out neg.bin
go run ./cmd/uvm-run neg.bin neg.csv 120 135
cat neg.csv
```

Ожидаемый результат: по адресу 128 значение -21.

### Пример 4: Программа с парными операциями (prog_pair_neg.json)

Программа выполняет две независимые операции с унарным минусом:

```bash
go run ./cmd/uvm-as --src prog_pair_neg.json --out pair.bin
go run ./cmd/uvm-run pair.bin pair.csv 0 32
cat pair.csv
```

Ожидаемые значения: Mem[20] = -77, Mem[21] = -512.

### Пример 5: Комбинированный сценарий (prog_mixed_neg.json)

Программа демонстрирует различные способы работы с унарным минусом:

```bash
go run ./cmd/uvm-as --src prog_mixed_neg.json --out mixed.bin
go run ./cmd/uvm-run mixed.bin mixed.csv 296 305
cat mixed.csv
```

Ожидаемые значения: Mem[300] = -888, Mem[301] = 17, Mem[302] = -17.

### Пример 6: Векторные операции (prog_vec_neg.json)

Программа применяет унарный минус к вектору из 6 элементов:

```bash
go run ./cmd/uvm-as --src prog_vec_neg.json --out vec.bin
go run ./cmd/uvm-run vec.bin vec.csv 96 210
cat vec.csv
```

Исходные данные в адресах 100-105: [5, 13, 0, 255, 1024, 4095]
Результаты в адресах 200-205: [-5, -13, 0, -255, -1024, -4095]

### Пример 7: Проверка конкретного диапазона памяти

Для проверки конкретных адресов памяти укажите соответствующий диапазон:

```bash
go run ./cmd/uvm-run prog.bin result.csv 100 200
```

Это сохранит дамп адресов от 100 до 200 включительно.
